# SPDX-FileCopyrightText: 2025 SAP SE or an SAP affiliate company and Greenhouse contributors
# SPDX-License-Identifier: Apache-2.0

name: "Heureka Store"
model_file: "./model.fga"

tuples:
  # Define the roles
  - user: user:system
    relation: admin
    object: role:system_role

  - user: user:k8s_asset_scanner
    relation: component_scanner
    object: role:system_role

  - user: user:keppel_scanner
    relation: issue_scanner
    object: role:system_role

  # Assign system role to each entity
  # Support Groups
  - user: role:system_role
    relation: role
    object: support_group:team_alpha

  - user: role:system_role
    relation: role
    object: support_group:team_beta

  # Services
  - user: role:system_role
    relation: role
    object: service:service_1

  - user: role:system_role
    relation: role
    object: service:service_2

  # Component Instances
  - user: role:system_role
    relation: role
    object: component_instance:comp_1

  - user: role:system_role
    relation: role
    object: component_instance:comp_2

  # Component Versions
  - user: role:system_role
    relation: role
    object: component_version:version_1

  - user: role:system_role
    relation: role
    object: component_version:version_2

  # Components (assuming you have instances)
  - user: role:system_role
    relation: role
    object: component:comp_1

  # Issue Matches (assuming you have instances)
  - user: role:system_role
    relation: role
    object: issue_match:match_1

  # Service relations
  - user: service:service_1
    relation: related_service
    object: component_instance:comp_1

  - user: component_instance:comp_1
    relation: component_instance
    object: component_version:version_1

  - user: service:service_2
    relation: related_service
    object: component_instance:comp_2

  - user: component_instance:comp_2
    relation: component_instance
    object: component_version:version_2

  - user: component_version:version_1
    relation: component_version
    object: component:comp_1

  - user: component_version:version_2
    relation: component_version
    object: component:comp_2


  # Regular user permissions - copied from original
  # Associate support groups with services
  - user: support_group:team_alpha
    relation: support_group
    object: service:service_1

  - user: support_group:team_beta
    relation: support_group
    object: service:service_2

  # Assign members to support groups
  - user: user:bob
    relation: member
    object: support_group:team_alpha

  - user: user:alice
    relation: member
    object: support_group:team_alpha

  - user: user:charlie
    relation: member
    object: support_group:team_beta

  - user: user:bob
    relation: member
    object: support_group:team_beta

tests:
  - name: "System user access tests"
    check:
      - user: "user:system"
        object: "support_group:team_alpha"
        assertions:
          can_view: true
          can_write: true
  - name: "Team Access Tests"
    check:
      - user: "user:bob"
        object: "support_group:team_alpha"
        assertions:
          can_view: true
      - user: "user:alice"
        object: "support_group:team_alpha"
        assertions:
          can_view: true
      - user: "user:charlie"
        object: "support_group:team_alpha"
        assertions:
          can_view: false
      - user: "user:charlie"
        object: "support_group:team_beta"
        assertions:
          can_view: true

  - name: "Service Access Tests"
    check:
      - user: "user:bob"
        object: "service:service_1"
        assertions:
          can_view: true
          can_write: false
      - user: "user:alice"
        object: "service:service_1"
        assertions:
          can_view: true
          can_write: false
      - user: "user:charlie"
        object: "service:service_1"
        assertions:
          can_view: false
      - user: "user:system"
        object: "service:service_1"
        assertions:
          can_view: true
          can_write: true
      - user: "user:k8s_asset_scanner"
        object: "service:service_1"
        assertions:
          can_view: true
          can_write: false
  - name: "Component Version Access Tests"
    check:
      - user: "user:bob"
        object: "component_version:version_1"
        assertions:
          can_view: true
      - user: "user:alice"
        object: "component_version:version_1"
        assertions:
          can_view: true
      - user: "user:charlie"
        object: "component_version:version_1"
        assertions:
          can_view: false
  - name: "Component Instance Access Tests"
    check:
      - user: "user:bob"
        object: "component_instance:comp_1"
        assertions:
          can_view: true
          can_write: false
      - user: "user:alice"
        object: "component_instance:comp_1"
        assertions:
          can_view: true
      - user: "user:charlie"
        object: "component_instance:comp_1"
        assertions:
          can_view: false
      - user: "user:k8s_asset_scanner"
        object: "component_instance:comp_1"
        assertions:
          can_view: true
          can_write: true
      - user: "user:keppel_scanner"
        object: "component_instance:comp_1"
        assertions:
          can_view: true
          can_write: false
      - user: "user:alice"
        object: "component_instance:comp_2"
        assertions:
          can_view: false