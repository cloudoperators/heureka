-- SPDX-FileCopyrightText: 2025 SAP SE or an SAP affiliate company and Greenhouse contributors
-- SPDX-License-Identifier: Apache-2.0

-- 1. Create the table (only if not exists to avoid errors if re-run)
CREATE TABLE IF NOT EXISTS mvSingleComponentByServiceVulnerabilityCounts (
    service_id INT UNSIGNED NOT NULL,
    component_id INT UNSIGNED NOT NULL,
    critical_count INT DEFAULT 0,
    high_count INT DEFAULT 0,
    medium_count INT DEFAULT 0,
    low_count INT DEFAULT 0,
    none_count INT DEFAULT 0,
    is_active TINYINT(1) NOT NULL DEFAULT 1,

    PRIMARY KEY (service_id, component_id),
    KEY idx_mvSingleComponent_active (is_active),

    constraint fk_mvsinglecomponentbyservicevulnerabilitycounts_service_id
        foreign key (service_id) references Service (service_id),
    constraint fk_mvsinglecomponentbyservicevulnerabilitycounts_component_id
        foreign key (component_id) references Component (component_id)
);

CREATE TABLE IF NOT EXISTS mvAllComponentsByServiceVulnerabilityCounts (
    service_id INT UNSIGNED NOT NULL,
    critical_count INT DEFAULT 0,
    high_count INT DEFAULT 0,
    medium_count INT DEFAULT 0,
    low_count INT DEFAULT 0,
    none_count INT DEFAULT 0,
    is_active TINYINT(1) NOT NULL DEFAULT 1,

    PRIMARY KEY (service_id),
    KEY idx_mvAllComponents_active (is_active),

    constraint fk_mvallcomponentsbyservicevulnerabilitycounts_service_id
        foreign key (service_id) references Service (service_id)
);

-- 2. Create or replace the procedure that refreshes the table
DROP PROCEDURE IF EXISTS refresh_mvSingleComponentByServiceVulnerabilityCounts_proc;
CREATE PROCEDURE refresh_mvSingleComponentByServiceVulnerabilityCounts_proc()
BEGIN
    -- mark all rows inactive
    UPDATE mvSingleComponentByServiceVulnerabilityCounts
       SET is_active = 0;

    -- upsert fresh data
    INSERT INTO mvSingleComponentByServiceVulnerabilityCounts
        (service_id, component_id, critical_count, high_count, medium_count, low_count, none_count, is_active)
    SELECT
        CI.componentinstance_service_id,
        CV.componentversion_component_id,
        COUNT(DISTINCT CASE WHEN IV.issuevariant_rating = 'Critical'
            THEN CONCAT(CV.componentversion_component_id, ',', IV.issuevariant_issue_id) END),
        COUNT(DISTINCT CASE WHEN IV.issuevariant_rating = 'High'
            THEN CONCAT(CV.componentversion_component_id, ',', IV.issuevariant_issue_id) END),
        COUNT(DISTINCT CASE WHEN IV.issuevariant_rating = 'Medium'
            THEN CONCAT(CV.componentversion_component_id, ',', IV.issuevariant_issue_id) END),
        COUNT(DISTINCT CASE WHEN IV.issuevariant_rating = 'Low'
            THEN CONCAT(CV.componentversion_component_id, ',', IV.issuevariant_issue_id) END),
        COUNT(DISTINCT CASE WHEN IV.issuevariant_rating = 'None'
            THEN CONCAT(CV.componentversion_component_id, ',', IV.issuevariant_issue_id) END),
        1
    FROM IssueMatch IM
    JOIN ComponentInstance CI ON CI.componentinstance_id = IM.issuematch_component_instance_id
    JOIN ComponentVersion CV ON CV.componentversion_id = CI.componentinstance_component_version_id
    JOIN IssueVariant IV ON IV.issuevariant_issue_id = IM.issuematch_issue_id
    JOIN Issue I ON I.issue_id = IV.issuevariant_issue_id
    LEFT JOIN Remediation R
      ON CI.componentinstance_service_id = R.remediation_service_id
     AND I.issue_id = R.remediation_issue_id
     AND R.remediation_deleted_at IS NULL
    WHERE IM.issuematch_status = 'new'
      AND I.issue_type = 'Vulnerability'
      AND IM.issuematch_deleted_at IS NULL
      AND I.issue_deleted_at IS NULL
      AND CI.componentinstance_deleted_at IS NULL
      AND CV.componentversion_deleted_at IS NULL
      AND (R.remediation_id IS NULL OR R.remediation_expiration_date < CURDATE())
    GROUP BY CI.componentinstance_service_id, CV.componentversion_component_id
    ON DUPLICATE KEY UPDATE
        critical_count = VALUES(critical_count),
        high_count     = VALUES(high_count),
        medium_count   = VALUES(medium_count),
        low_count      = VALUES(low_count),
        none_count     = VALUES(none_count),
        is_active      = 1;
END;



DROP PROCEDURE IF EXISTS refresh_mvAllComponentsByServiceVulnerabilityCounts_proc;
CREATE PROCEDURE refresh_mvAllComponentsByServiceVulnerabilityCounts_proc()
BEGIN
    -- mark all rows inactive
    UPDATE mvAllComponentsByServiceVulnerabilityCounts
       SET is_active = 0;

    -- upsert fresh data
    INSERT INTO mvAllComponentsByServiceVulnerabilityCounts
        (service_id, critical_count, high_count, medium_count, low_count, none_count, is_active)
    SELECT
        CI.componentinstance_service_id,
        COUNT(DISTINCT CASE WHEN IV.issuevariant_rating = 'Critical'
            THEN CONCAT(CV.componentversion_component_id, ',', IV.issuevariant_issue_id) END),
        COUNT(DISTINCT CASE WHEN IV.issuevariant_rating = 'High'
            THEN CONCAT(CV.componentversion_component_id, ',', IV.issuevariant_issue_id) END),
        COUNT(DISTINCT CASE WHEN IV.issuevariant_rating = 'Medium'
            THEN CONCAT(CV.componentversion_component_id, ',', IV.issuevariant_issue_id) END),
        COUNT(DISTINCT CASE WHEN IV.issuevariant_rating = 'Low'
            THEN CONCAT(CV.componentversion_component_id, ',', IV.issuevariant_issue_id) END),
        COUNT(DISTINCT CASE WHEN IV.issuevariant_rating = 'None'
            THEN CONCAT(CV.componentversion_component_id, ',', IV.issuevariant_issue_id) END),
        1
    FROM IssueMatch IM
    JOIN ComponentInstance CI ON CI.componentinstance_id = IM.issuematch_component_instance_id
    JOIN ComponentVersion CV ON CV.componentversion_id = CI.componentinstance_component_version_id
    JOIN IssueVariant IV ON IV.issuevariant_issue_id = IM.issuematch_issue_id
    JOIN Issue I ON I.issue_id = IV.issuevariant_issue_id
    LEFT JOIN Remediation R
      ON CI.componentinstance_service_id = R.remediation_service_id
     AND I.issue_id = R.remediation_issue_id
     AND R.remediation_deleted_at IS NULL
    WHERE IM.issuematch_status = 'new'
      AND I.issue_type = 'Vulnerability'
      AND IM.issuematch_deleted_at IS NULL
      AND I.issue_deleted_at IS NULL
      AND CI.componentinstance_deleted_at IS NULL
      AND CV.componentversion_deleted_at IS NULL
      AND (R.remediation_id IS NULL OR R.remediation_expiration_date < CURDATE())
    GROUP BY CI.componentinstance_service_id
    ON DUPLICATE KEY UPDATE
        critical_count = VALUES(critical_count),
        high_count     = VALUES(high_count),
        medium_count   = VALUES(medium_count),
        low_count      = VALUES(low_count),
        none_count     = VALUES(none_count),
        is_active      = 1;
END;

-- 3. Run the procedure once to populate the table initially
-- CALL refresh_mvSingleComponentByServiceVulnerabilityCounts_proc();
-- CALL refresh_mvAllComponentsByServiceVulnerabilityCounts_proc();

-- -- 4. Create the event to run the procedure every hour
CREATE EVENT IF NOT EXISTS refresh_mvSingleComponentByServiceVulnerabilityCounts
ON SCHEDULE EVERY 1 HOUR
DO
  CALL refresh_mvSingleComponentByServiceVulnerabilityCounts_proc();


CREATE EVENT IF NOT EXISTS refresh_mvAllComponentsByServiceVulnerabilityCounts
ON SCHEDULE EVERY 1 HOUR
DO
  CALL refresh_mvAllComponentsByServiceVulnerabilityCounts_proc();
