name: "Tests"
on: [pull_request]

jobs:
  tests:
    runs-on: [ ubuntu-latest ]
    services:
      mariadb:
        image: mariadb:latest
        ports:
          - "3306:3306"
        env:
          MARIADB_USER: my_username
          MARIADB_PASSWORD: my_password
          MARIADB_DATABASE: heureka
          MARIADB_ROOT_PASSWORD: my_password
        options: --health-cmd="healthcheck.sh --connect --innodb_initialized" --health-interval=10s --health-timeout=5s --health-retries=3
      valkey:
        image: valkey/valkey:7.2
        ports:
          - "6379:6379"
    steps:
      - uses: actions/checkout@v6

      # MAYBE IT WOULD BE GOOD IDEA TO TEST MIGRATION ON DETECTED SCHEMA CHANGE
      # install mariadb client (NOT server â€” just CLI)
      - name: Install MariaDB client
        run: sudo apt-get update && sudo apt-get install -y mariadb-client

      # install migrate tool if needed
      - name: Install migrate
        run: |
          curl -L https://github.com/golang-migrate/migrate/releases/latest/download/migrate.linux-amd64.tar.gz \
            | tar xvz
          sudo mv migrate /usr/local/bin/

      - name: Wait for DB ready (extra safety)
        run: |
          for i in {1..30}; do
            mariadb -h 127.0.0.1 -P 3306 -u my_username -pmy_password -e "SELECT 1" && break
            sleep 2
          done

      - name: Run migrations
        run: make migration-test

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
      - name: Install Ginkgo
        run: go install github.com/onsi/ginkgo/v2/ginkgo
      - name: Install Mockery
        run: go install github.com/vektra/mockery/v2@v2.53.5
      - name: Generate Mockery code
        run: make mockery
      - name: Generate Gqlgen code
        run: make gqlgen
      - name: Run Tests
        env:
          DB_USER: my_username
          DB_PASSWORD: my_password
          DB_ROOT_PASSWORD: my_password
          DB_NAME: heureka
          DB_ADDRESS: localhost
          DB_PORT: 3306
          DB_SCHEMA: internal/database/mariadb/init/schema.sql
        run: ginkgo --trace -r -randomize-all -randomize-suites
